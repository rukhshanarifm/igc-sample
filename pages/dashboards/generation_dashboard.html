<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generation - Real Time Dashboards</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #f5f7f6; }
        .header { background: linear-gradient(135deg,#1B5E20 0%,#2E7D32 100%); color: white; padding: 20px; border-radius: 8px; display:flex; align-items:center; gap:20px; }
        .header h1 { margin:0; font-size:1.6rem; }
        .nav { margin-top: 12px; display:flex; gap:12px; }
        .nav a { color: white; text-decoration: none; background: rgba(255,255,255,0.08); padding:8px 12px; border-radius:6px; }
        .container { margin-top: 20px; display:grid; grid-template-columns: 1fr; gap: 18px; }
        .chart-box { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: all 0.3s ease; }
        .chart-title { font-weight: 700; margin-bottom: 8px; color:#333; }
        @media (min-width:900px) { .container { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>Generation Dashboard â€” Real Time Data</h1>
            <div style="font-size:0.95rem; opacity:0.9">Time series analysis of electricity generation by source (Hydel, Coal, Gas, RLNG, Nuclear, Wind, Solar, etc.)</div>
            <div class="nav">
                <a href="../../index.html">Home</a>
                <a href="../sectors/power/power_sector.html">Power Sector</a>
                <a href="power_dashboards.html">Real Time Dashboards</a>
                <a href="td_loss_dashboard.html">Transmission & Distribution</a>
                <a href="generation_dashboard.html" style="background: rgba(255,255,255,0.16);">Generation</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="chart-box" id="subsidies-section">
            <div class="chart-title">Subsidies (PKR Billion)</div>
            <div id="subsidiesChart" style="height:320px;"></div>
        </div>

        <div class="chart-box" id="utilization-section">
            <div class="chart-title">Utilization of Average Available Capacity (%, year)</div>
            <div id="utilizationChart" style="height:320px;"></div>
        </div>

        <div class="chart-box" id="feeders-section">
            <div class="chart-title">% of Feeders with Load Management &gt; 3 hours</div>
            <div id="feedersChart" style="height:320px;"></div>
        </div>

        <div class="chart-box" id="tariff-section">
            <div class="chart-title">Tariff (PKR)</div>
            <div id="tariffChart" style="height:320px;"></div>
        </div>

        <div class="chart-box" id="total-generation-section" style="grid-column: 1 / -1;">
            <div class="chart-title">Total Electricity Generation (GWh)</div>
            <div id="totalGenerationChart" style="height:400px;"></div>
        </div>

        <div class="chart-box" id="renewable-section">
            <div class="chart-title">Renewable Energy Generation (Hydel, Wind, Solar, Bagasse)</div>
            <div id="renewableChart" style="height:320px;"></div>
        </div>

        <div class="chart-box" id="nuclear-section">
            <div class="chart-title">Nuclear Generation (GWh)</div>
            <div id="nuclearChart" style="height:320px;"></div>
        </div>

        <div class="chart-box" id="import-section">
            <div class="chart-title">Electricity Imported from Iran (GWh)</div>
            <div id="importChart" style="height:320px;"></div>
        </div>
    </div>

    <script>
        // Load and parse NEPRA generation CSV data
        async function loadGenerationData() {
            try {
                const response = await fetch('../../data/generation/nepra_generation.csv');
                const csvText = await response.text();
                
                // Parse CSV - NEPRA format has quoted fields
                const lines = csvText.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
                
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    // Handle quoted CSV fields properly
                    const matches = lines[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                    if (!matches) continue;
                    
                    const values = matches.map(v => v.replace(/^"|"$/g, '').trim());
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
                
                return data;
            } catch (error) {
                console.error('Error loading CSV data:', error);
                return null;
            }
        }

        // Parse and organize generation data by date and source
        function organizeGenerationData(rawData) {
            if (!rawData || rawData.length === 0) return null;
            
            const dataByDate = {};
            
            rawData.forEach(row => {
                const date = row['Observation Date'];
                const seriesName = row['Series name'];
                const value = parseFloat(row['Observation Value']) || 0;
                
                if (!date || !seriesName) return;
                
                if (!dataByDate[date]) {
                    dataByDate[date] = {};
                }
                
                dataByDate[date][seriesName] = value;
            });
            
            // Sort dates chronologically
            const sortedDates = Object.keys(dataByDate).sort((a, b) => new Date(a) - new Date(b));
            
            return {
                dates: sortedDates,
                data: dataByDate
            };
        }

        // Format date for display
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const month = date.toLocaleString('en-US', { month: 'short' });
            const year = date.getFullYear().toString().slice(-2);
            return `${month}-${year}`;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Load real NEPRA data
            const rawData = await loadGenerationData();
            
            if (!rawData || rawData.length === 0) {
                console.error('Failed to load generation data');
                return;
            }
            
            const organized = organizeGenerationData(rawData);
            if (!organized) {
                console.error('Failed to organize generation data');
                return;
            }
            
            const { dates, data } = organized;
            const formattedDates = dates.map(formatDate);
            
            // Extract data for each source
            const totalGen = dates.map(d => data[d]['Total Electricity Generation by all sources'] || 0);
            const hydel = dates.map(d => data[d]['Electricity Generation by Hydel'] || 0);
            const coal = dates.map(d => data[d]['Electricity Generation by Coal'] || 0);
            const hsd = dates.map(d => data[d]['Electricity Generation by High Speed Diesel (HSD)'] || 0);
            const rfo = dates.map(d => data[d]['Electricity Generation by Residual Fuel Oil (RFO)'] || 0);
            const gas = dates.map(d => data[d]['Electricity Generation by Gas'] || 0);
            const rlng = dates.map(d => data[d]['Electricity Generation by Regasification Liquefied Natural Gas(RLNG)'] || 0);
            const nuclear = dates.map(d => data[d]['Electricity Generation by Nuclear'] || 0);
            const iran = dates.map(d => data[d]['Electricity Imported from Iran'] || 0);
            const mixed = dates.map(d => data[d]['Electricity Generation by Mixed'] || 0);
            const wind = dates.map(d => data[d]['Electricity Generation by Wind'] || 0);
            const bagasse = dates.map(d => data[d]['Electricity Generation by bagasse'] || 0);
            const solar = dates.map(d => data[d]['Electricity Generation by Solar'] || 0);
            
            // Store all data globally for period filtering
            window.generationData = {
                dates: formattedDates,
                rawDates: dates,
                hydel, coal, hsd, rfo, gas, rlng, nuclear, iran, mixed, wind, bagasse, solar, totalGen
            };
            
            const commonLayout = (title, yTitle) => ({
                margin: {t:40, b:60, l:60, r:20},
                xaxis: { title: 'Month', tickangle: -45 },
                yaxis: { title: yTitle },
                hovermode: 'x unified',
            });

            // Generate random data for old metrics (subsidies, utilization, feeders, tariff)
            function randomRange(min, max) { return Math.random() * (max - min) + min; }
            const subsidies = formattedDates.map(() => +(randomRange(50, 300)).toFixed(1));
            const utilization = formattedDates.map(() => +(randomRange(50, 95)).toFixed(1));
            const feeders = formattedDates.map(() => +(randomRange(2, 30)).toFixed(1));
            const tariff = formattedDates.map(() => +(randomRange(12, 30)).toFixed(2));

            // Plot old metrics
            Plotly.newPlot('subsidiesChart', [{ x: formattedDates, y: subsidies, type: 'scatter', mode: 'lines+markers', line: {color: '#1f77b4'} }], 
                commonLayout('Subsidies', 'PKR Billion'), {responsive:true});

            Plotly.newPlot('utilizationChart', [{ x: formattedDates, y: utilization, type: 'scatter', mode: 'lines+markers', line: {color: '#2ca02c'} }], 
                commonLayout('Utilization', '%'), {responsive:true});

            Plotly.newPlot('feedersChart', [{ x: formattedDates, y: feeders, type: 'scatter', mode: 'lines+markers', line: {color: '#ff7f0e'} }], 
                commonLayout('Feeders with Load Management', '%'), {responsive:true});

            Plotly.newPlot('tariffChart', [{ x: formattedDates, y: tariff, type: 'scatter', mode: 'lines+markers', line: {color: '#d62728'} }], 
                commonLayout('Tariff', 'PKR'), {responsive:true});

            // 1. Total Generation Chart
            Plotly.newPlot('totalGenerationChart', [{
                x: formattedDates,
                y: totalGen,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Total Generation',
                line: { color: '#1B5E20', width: 3 },
                marker: { size: 6 }
            }], {
                ...commonLayout('Total Electricity Generation Over Time', 'Generation (GWh)'),
                title: { text: 'Total Electricity Generation Over Time', font: { size: 16 } }
            }, {responsive: true});

            // 2. Renewable Energy Chart
            Plotly.newPlot('renewableChart', [
                { x: formattedDates, y: hydel, name: 'Hydel', type: 'scatter', mode: 'lines+markers', line: { color: '#2196F3' } },
                { x: formattedDates, y: wind, name: 'Wind', type: 'scatter', mode: 'lines+markers', line: { color: '#4CAF50' } },
                { x: formattedDates, y: solar, name: 'Solar', type: 'scatter', mode: 'lines+markers', line: { color: '#FFC107' } },
                { x: formattedDates, y: bagasse, name: 'Bagasse', type: 'scatter', mode: 'lines+markers', line: { color: '#8BC34A' } }
            ], {
                ...commonLayout('Renewable Energy Sources', 'Generation (GWh)'),
                showlegend: true,
                legend: { x: 0.02, y: 0.98 }
            }, {responsive: true});

            // 3. Nuclear Chart
            Plotly.newPlot('nuclearChart', [{
                x: formattedDates,
                y: nuclear,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Nuclear',
                line: { color: '#9C27B0', width: 2 },
                marker: { size: 6 },
                fill: 'tozeroy'
            }], {
                ...commonLayout('Nuclear Generation', 'Generation (GWh)'),
                showlegend: false
            }, {responsive: true});

            // 4. Iran Import Chart
            Plotly.newPlot('importChart', [{
                x: formattedDates,
                y: iran,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Iran Import',
                line: { color: '#00BCD4', width: 2 },
                marker: { size: 6 },
                fill: 'tozeroy'
            }], {
                ...commonLayout('Electricity Imported from Iran', 'Generation (GWh)'),
                showlegend: false
            }, {responsive: true});
        });
    </script>
</body>
</html>
